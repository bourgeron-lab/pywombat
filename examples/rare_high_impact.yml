# ============================================================================
# PyWombat Configuration: Rare Variants with High Impact
# ============================================================================
#
# Filters for ultra-rare, high-impact variants in rare disease studies.
# Combines strict quality filters with functional impact and frequency criteria.
#
# Target variants:
#   • High functional impact (VEP: HIGH, LoF with high confidence)
#   • Ultra-rare frequency (≤0.1% in gnomAD genomes v4)
#   • High genotype quality (GQ ≥ 19, DP ≥ 10)
#   • Proper allelic balance for het/hom calls
#   • Pass gnomAD filters OR annotated as pathogenic
#
# Usage:
#   uvx pywombat filter input.tsv -F examples/rare_variants_high_impact.yml -o output
#   uvx pywombat filter prepared.parquet -F examples/rare_variants_high_impact.yml -o output
#
# ============================================================================

# ----------------------------------------------------------------------------
# Quality Filters
# ----------------------------------------------------------------------------
# Ensures high-confidence variant calls with proper genotype quality

quality:
  sample_dp_min: 10 # Minimum read depth (coverage)
  sample_gq_min: 19 # Minimum genotype quality score

  # VAF (variant allele frequency) thresholds ensure proper allelic balance
  sample_vaf_het_min: 0.25 # Het (0/1): minimum 25% alternate allele
  sample_vaf_het_max: 0.75 # Het (0/1): maximum 75% to exclude mis-called hom
  sample_vaf_homalt_min: 0.85 # Hom alt (1/1): minimum 85% alternate allele
  sample_vaf_hom_ref_max: 0.15 # Hom ref (0/0): maximum 15% alternate allele

  apply_to_parents: false # Apply same quality filters to parent genotypes
  filter_no_alt_allele: true # Exclude 0/0 and ./. genotypes

  # Uncomment to filter for only homozygous alternative 1/1 variants
  # Useful for recessive disease analysis and homozygosity mapping
  # See examples/rare_homalt.yml for a complete recessive analysis example
  # homalt_only: false

# ----------------------------------------------------------------------------
# Expression Filter
# ----------------------------------------------------------------------------
# Multi-criteria filter combining functional annotation and frequency
#
# Logic breakdown:
#   1. Canonical transcript with HIGH impact and clean LoF annotation
#   2. Ultra-rare in gnomAD genomes (≤0.1% or absent)
#   3. EITHER:
#      a) Pass gnomAD filters with variant-type-specific quality (SNV: AQ>15, INDEL: AQ>22)
#      b) OR annotated as pathogenic (regardless of filters/quality)
#
# Key operators used:
#   • is_snv / is_indel: Variant type predicates (REF/ALT are single nucleotides)
#   • is_empty: Checks for null/empty/. values
#   • contains: Case-insensitive substring matching
#
expression: >
  VEP_CANONICAL = YES &
  VEP_IMPACT = HIGH &
  VEP_LoF = HC &
  VEP_LoF_flags = . &
  (fafmax_faf95_max_genomes = null | fafmax_faf95_max_genomes <= 0.001) &
  (
    (
      ((is_snv & AQ > 15) | (is_indel & AQ > 22)) &
      genomes_filters is_empty
    ) |
    (VEP_CLIN_SIG contains 'pathogenic')
  )

# ----------------------------------------------------------------------------
# Required Input Columns
# ----------------------------------------------------------------------------
#
# VEP annotations (from bcftools +split-vep):
#   • VEP_CANONICAL: Whether transcript is canonical (YES/NO)
#   • VEP_IMPACT: Predicted impact (HIGH, MODERATE, LOW, MODIFIER)
#   • VEP_LoF: Loss-of-function annotation (HC = high confidence)
#   • VEP_LoF_flags: Flags indicating LoF artifacts (. = no flags)
#   • VEP_CLIN_SIG: ClinVar clinical significance
#
# gnomAD v4 annotations:
#   • fafmax_faf95_max_genomes: Filtering allele frequency (95% CI) in genomes
#   • genomes_filters: gnomAD filter flags (empty = PASS)
#
# Quality metrics:
#   • AQ: Variant quality score
#   • REF/ALT: Reference and alternate alleles (for is_snv/is_indel)
#
# ============================================================================
